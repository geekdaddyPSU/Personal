---
# Ensure cgroup memory flags are enabled for MicroK8s
# This modifies /boot/firmware/cmdline.txt safely and reboots if changed.

- name: Read existing kernel command line
  slurp:
    src: /boot/firmware/cmdline.txt
  register: cmdline_raw

- name: Decode current cmdline contents
  set_fact:
    cmdline_current: "{{ cmdline_raw.content | b64decode | trim }}"

- name: Check if cgroup flags are missing
  set_fact:
    cgroup_needed: "{{ ('cgroup_enable=memory' not in cmdline_current) or ('cgroup_memory=1' not in cmdline_current) }}"

- name: Add cgroup memory flags to /boot/firmware/cmdline.txt
  copy:
    dest: /boot/firmware/cmdline.txt
    content: "{{ cmdline_current }} cgroup_enable=memory cgroup_memory=1\n"
    owner: root
    group: root
    mode: "0644"
  when: cgroup_needed
  register: cgroup_update

- name: Notify if /boot/firmware/cmdline.txt was modified
  debug:
    msg: "Updated /boot/firmware/cmdline.txt on {{ inventory_hostname }} to enable cgroup memory support."
  when: cgroup_update is changed

- name: Reboot if cgroup flags were added
  reboot:
    msg: "Rebooting {{ inventory_hostname }} to apply cgroup memory settings."
    connect_timeout: 5
    reboot_timeout: 600
  when: cgroup_update is changed
